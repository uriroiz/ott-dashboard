<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Data Debug Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #2563eb; }
        h2 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        .stat { 
            display: inline-block;
            background: #eff6ff;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px;
            border-left: 4px solid #3b82f6;
        }
        .stat-label { font-size: 14px; color: #64748b; }
        .stat-value { font-size: 24px; font-weight: bold; color: #1e40af; }
        .warning { background: #fef3c7; border-left-color: #f59e0b; }
        .error { background: #fee2e2; border-left-color: #ef4444; }
        .success { background: #d1fae5; border-left-color: #10b981; }
        #upload { 
            padding: 15px;
            border: 2px dashed #3b82f6;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        #upload:hover { background: #eff6ff; border-color: #1e40af; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f3f4f6;
            font-weight: bold;
            color: #1f2937;
        }
        tr:hover { background: #f9fafb; }
        .filtered-out { color: #ef4444; }
        .included { color: #10b981; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ” ×›×œ×™ × ×™×¤×•×™ ×©×’×™××•×ª × ×ª×•× ×™×</h1>
        <p>×”×¢×œ×” ××ª ×§×•×‘×¥ ×”-Excel ×©×œ×š ×›×“×™ ×œ×¨××•×ª ×‘×“×™×•×§ ××” ××¡×•× ×Ÿ ×•×œ××”</p>
        
        <div id="upload">
            <p>ğŸ“ ×œ×—×¥ ××• ×’×¨×•×¨ ×§×•×‘×¥ Excel ×œ×›××Ÿ</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
        </div>
    </div>

    <div id="results"></div>

    <script>
        const leaguePatterns = {
          '×œ×™×’×ª ××ª× ×” ×•×•×™× ×¨': ['×œ×™×’×ª ××ª× ×” ×•×•×™× ×¨', '×œ×™×’×ª ××ª× ×” ×•×™× ×¨', '××ª× ×” ×•×•×™× ×¨', '××ª× ×” ×•×™× ×¨'],
          '×œ×™×’×” ×œ××•××™×ª Winner': ['×œ×™×’×” ×œ××•××™×ª Winner', '×œ×™×’×” ×œ××•××™×ª ×•×™× ×¨', '×œ×™×’×” ×œ××•××™×ª winner'],
          '×”×œ×™×’×” ×œ× ×¢×¨×™× × ×œ××•××™×ª': ['×”×œ×™×’×” ×œ× ×¢×¨×™× × ×œ××•××™×ª', '×œ×™×’×” ×œ× ×¢×¨×™× × ×œ××•××™×ª', '× ×¢×¨×™× × ×œ××•××™×ª'],
          '×œ×™×’×ª ××§×“×•× ×œ×“\'×¡ ×œ× ×•×¢×¨': ['×œ×™×’×ª ××§×“×•× ×œ×“\'×¡ ×œ× ×•×¢×¨', '×œ×™×’×ª ××§×“×•× ×œ×“×¡ ×œ× ×•×¢×¨', '××§×“×•× ×œ×“\'×¡ ×œ× ×•×¢×¨', '××§×“×•× ×œ×“×¡ ×œ× ×•×¢×¨'],
          '×”×œ×™×’×” ×”×œ××•××™×ª ×œ× ×©×™×': ['×”×œ×™×’×” ×”×œ××•××™×ª ×œ× ×©×™×', '×œ×™×’×” ×œ××•××™×ª ×œ× ×©×™×', '×œ×™×’×” ×œ× ×©×™×'],
          '×”×œ×™×’×” ×œ× ×¢×¨×•×ª × ×¢×œ': ['×”×œ×™×’×” ×œ× ×¢×¨×•×ª × ×¢×œ', '×œ×™×’×” ×œ× ×¢×¨×•×ª × ×¢×œ', '× ×¢×¨×•×ª × ×¢×œ', '×œ×™×’×” ×œ× ×¢×¨×•×ª ×\' ×¢×œ']
        };

        const cutoffDate = new Date('2025-10-31T23:59:59');

        function identifyLeague(eventName) {
          if (!eventName) return null;
          
          for (const [leagueName, patterns] of Object.entries(leaguePatterns)) {
            for (const pattern of patterns) {
              if (eventName.includes(pattern)) {
                return leagueName;
              }
            }
          }
          return null;
        }

        function parseExcelDate(excelDate) {
          if (!excelDate) return null;
          if (excelDate instanceof Date) return excelDate;
          if (typeof excelDate === 'number') {
            const excelEpoch = new Date(1899, 11, 30);
            return new Date(excelEpoch.getTime() + excelDate * 86400000);
          }
          if (typeof excelDate === 'string') {
            const date = new Date(excelDate);
            if (!isNaN(date.getTime())) return date;
            const parts = excelDate.split('/');
            if (parts.length === 3) {
              const month = parseInt(parts[0]) - 1;
              const day = parseInt(parts[1]);
              const year = parseInt(parts[2]);
              return new Date(year, month, day);
            }
          }
          return null;
        }

        document.getElementById('upload').onclick = () => document.getElementById('fileInput').click();
        
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(firstSheet, { defval: null, raw: false });

                analyzeData(rawData);
            };
            reader.readAsArrayBuffer(file);
        };

        function analyzeData(rawData) {
            const stats = {
                total: rawData.length,
                withLeague: 0,
                withoutLeague: 0,
                beforeCutoff: 0,
                afterCutoff: 0,
                validData: 0,
                passed: 0,
                filtered: 0
            };

            const filteredReasons = {};
            const leagueBreakdown = {};
            const dateIssues = [];

            rawData.forEach((row, idx) => {
                const eventName = row['eventname'] || '';
                const eventDate = parseExcelDate(row['Event Date']);
                const league = identifyLeague(eventName);
                const views = parseFloat(row['Views']) || 0;
                const users = parseFloat(row['unique users']) || 0;

                // League check
                if (league) {
                    stats.withLeague++;
                    leagueBreakdown[league] = (leagueBreakdown[league] || 0) + 1;
                } else {
                    stats.withoutLeague++;
                }

                // Date check
                if (eventDate) {
                    if (eventDate <= cutoffDate) {
                        stats.beforeCutoff++;
                    } else {
                        stats.afterCutoff++;
                        dateIssues.push({
                            row: idx + 2,
                            event: eventName,
                            date: eventDate.toLocaleDateString('he-IL')
                        });
                    }
                }

                // Valid data
                if (views >= 0 && users >= 0) {
                    stats.validData++;
                }

                // Final filter
                const hasLeague = league && Object.keys(leaguePatterns).includes(league);
                const validDate = !eventDate || eventDate <= cutoffDate;
                const hasValidData = views >= 0 && users >= 0;

                if (hasLeague && validDate && hasValidData) {
                    stats.passed++;
                } else {
                    stats.filtered++;
                    const reason = [];
                    if (!hasLeague) reason.push('××™×Ÿ ×œ×™×’×” ××–×•×”×”');
                    if (!validDate) reason.push('×ª××¨×™×š ××—×¨×™ 31/10/2025');
                    if (!hasValidData) reason.push('× ×ª×•× ×™× ×œ× ×ª×§×™× ×™×');
                    
                    const key = reason.join(' + ');
                    filteredReasons[key] = (filteredReasons[key] || 0) + 1;
                }
            });

            displayResults(stats, filteredReasons, leagueBreakdown, dateIssues);
        }

        function displayResults(stats, filteredReasons, leagueBreakdown, dateIssues) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="card">
                    <h2>ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™</h2>
                    <div class="stat">
                        <div class="stat-label">×¡×š ×©×•×¨×•×ª ×‘×§×•×‘×¥</div>
                        <div class="stat-value">${stats.total}</div>
                    </div>
                    <div class="stat success">
                        <div class="stat-label">âœ… ×¢×•×‘×¨ ×¡×™× ×•×Ÿ</div>
                        <div class="stat-value">${stats.passed}</div>
                    </div>
                    <div class="stat error">
                        <div class="stat-label">âŒ ××¡×•× ×Ÿ ×”×—×•×¦×”</div>
                        <div class="stat-value">${stats.filtered}</div>
                    </div>
                    <div class="stat ${stats.filtered > 0 ? 'warning' : 'success'}">
                        <div class="stat-label">××—×•×– ×¡×™× ×•×Ÿ</div>
                        <div class="stat-value">${((stats.filtered / stats.total) * 100).toFixed(1)}%</div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ€ ×–×™×”×•×™ ×œ×™×’×•×ª</h2>
                    <div class="stat success">
                        <div class="stat-label">âœ… ×¢× ×œ×™×’×” ××–×•×”×”</div>
                        <div class="stat-value">${stats.withLeague}</div>
                    </div>
                    <div class="stat ${stats.withoutLeague > 0 ? 'error' : 'success'}">
                        <div class="stat-label">âŒ ×œ×œ× ×œ×™×’×” ××–×•×”×”</div>
                        <div class="stat-value">${stats.withoutLeague}</div>
                    </div>
                    
                    <h3>×¤×™×¨×•×˜ ×œ×¤×™ ×œ×™×’×•×ª:</h3>
                    <table>
                        <tr><th>×œ×™×’×”</th><th>××¡×¤×¨ ××©×—×§×™×</th></tr>
                        ${Object.entries(leagueBreakdown).map(([league, count]) => 
                            `<tr><td>${league}</td><td class="included">${count}</td></tr>`
                        ).join('')}
                    </table>
                </div>

                <div class="card">
                    <h2>ğŸ“… ×¡×™× ×•×Ÿ ×ª××¨×™×›×™×</h2>
                    <p><strong>×ª××¨×™×š ×—×™×ª×•×š:</strong> 31 ×‘××•×§×˜×•×‘×¨ 2025</p>
                    <div class="stat success">
                        <div class="stat-label">âœ… ×¢×“ 31/10/2025</div>
                        <div class="stat-value">${stats.beforeCutoff}</div>
                    </div>
                    <div class="stat ${stats.afterCutoff > 0 ? 'error' : 'success'}">
                        <div class="stat-label">âŒ ××—×¨×™ 31/10/2025</div>
                        <div class="stat-value">${stats.afterCutoff}</div>
                    </div>

                    ${stats.afterCutoff > 0 ? `
                        <h3>××©×—×§×™× ×©×¡×•× × ×• ×‘×’×œ×œ ×ª××¨×™×š:</h3>
                        <table>
                            <tr><th>×©×•×¨×”</th><th>××™×¨×•×¢</th><th>×ª××¨×™×š</th></tr>
                            ${dateIssues.slice(0, 20).map(issue => 
                                `<tr><td>${issue.row}</td><td>${issue.event}</td><td class="filtered-out">${issue.date}</td></tr>`
                            ).join('')}
                            ${dateIssues.length > 20 ? `<tr><td colspan="3">...×•×¢×•×“ ${dateIssues.length - 20} ××©×—×§×™×</td></tr>` : ''}
                        </table>
                    ` : ''}
                </div>

                <div class="card">
                    <h2>ğŸ” ×¡×™×‘×•×ª ×œ×¡×™× ×•×Ÿ</h2>
                    <table>
                        <tr><th>×¡×™×‘×”</th><th>××¡×¤×¨ ×©×•×¨×•×ª</th></tr>
                        ${Object.entries(filteredReasons).map(([reason, count]) => 
                            `<tr><td class="filtered-out">${reason}</td><td>${count}</td></tr>`
                        ).join('')}
                    </table>
                </div>

                <div class="card">
                    <h2>ğŸ’¡ ×”××œ×¦×•×ª</h2>
                    <ul>
                        ${stats.withoutLeague > 0 ? `
                            <li><strong>âŒ ${stats.withoutLeague} ××©×—×§×™× ×œ×œ× ×œ×™×’×” ××–×•×”×”:</strong>
                                <br>×‘×“×•×§ ××ª ×©× ×”××™×¨×•×¢ (eventname) ×‘Excel. ×”×•× ×—×™×™×‘ ×œ×›×œ×•×œ ××ª ×©× ×”×œ×™×’×” ×”××œ×.</li>
                        ` : ''}
                        ${stats.afterCutoff > 0 ? `
                            <li><strong>âŒ ${stats.afterCutoff} ××©×—×§×™× ××—×¨×™ 31/10/2025:</strong>
                                <br>×× ××ª×” ×¨×•×¦×” ×œ×›×œ×•×œ ××©×—×§×™× ×× ×•×‘××‘×¨, ×¦×¨×™×š ×œ×©× ×•×ª ××ª ×ª××¨×™×š ×”×—×™×ª×•×š ×‘×§×•×“.</li>
                        ` : ''}
                        ${stats.filtered === 0 ? `
                            <li><strong>âœ… ×›×œ ×”× ×ª×•× ×™× ×¢×•×‘×¨×™×!</strong> ××™×Ÿ ×©×•× ×“×‘×¨ ××¡×•× ×Ÿ.</li>
                        ` : ''}
                    </ul>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>


